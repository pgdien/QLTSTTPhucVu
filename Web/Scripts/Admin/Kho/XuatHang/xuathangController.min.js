admin.controller("xuathangController",["$scope","$http",function(n,t){function a(){v();s();h();w()}function v(){var t=new Date;n.filterXuatHang.denNgay=t;n.filterXuatHang.tuNgay=new Date(t.getFullYear(),t.getMonth(),1);f()}function y(t){var r=!1,u;angular.forEach(n.chitietXuatHangs,function(n){n.idMatHang==t.id&&(r=!0,toastr.warning("Đã tồn tại","Mặt hàng"))});r==!1&&(u={idMatHang:t.id,idXuatHang:n.xuathang.id,soluong:1,dongia:t.dongia},n.chitietXuatHangs.push(u));i()}function i(){var t=0;angular.forEach(n.chitietXuatHangs,function(i,r){n.chitietXuatHangs[r].thanhtien=parseFloat(i.dongia)*parseFloat(i.soluong);t=parseFloat(t)+parseFloat(n.chitietXuatHangs[r].thanhtien)});n.xuathang.tongTien=t}function f(){if(n.filterXuatHang.tuNgay==null||n.filterXuatHang.denNgay==null)toastr.warning("Vui lòng chọn Từ ngày - Đến ngày");else{var i=n.filterXuatHang.tuNgay,r=n.filterXuatHang.denNgay;t.get(e+"?tuNgayDay="+i.getDate()+"&&tuNgayMonth="+(i.getMonth()+1)+"&&tuNgayYear="+i.getFullYear()+"&&denNgayDay="+r.getDate()+"&&denNgayMonth="+(r.getMonth()+1)+"&&denNgayYear="+r.getFullYear()).then(function(t){t.status==200&&(n.xuathangs=t.data)})}}function p(i){i!=null&&t.get(o+"?att=idXuatHang&&value="+i).then(function(t){t.status==200&&(n.chitietXuatHangReviews=angular.copy(t.data))})}function s(){t.get(r).then(function(t){t.status==200&&(n.donvitinhs=t.data)})}function w(){t.get(c).then(function(t){t.status==200&&(n.mathangs=t.data)})}function h(){t.get(u).then(function(t){t.status==200&&(n.lydoXuats=t.data)})}var e,o,c,r,u,l;n.xuathangs=[];n.xuathang={};n.xuathangReview={};n.selectedXuatHangs=[];n.filterXuatHang={};e="/API/KT_XuatHangAPI";n.chitietXuatHangs=[];n.chitietXuatHang={};n.chitietXuatHangReviews=[];o="/API/KT_ChiTietXuatHangAPI";n.mathangs=[];n.mathang={};n.selectedMatHangs=[];c="/API/DM_MatHangAPI";n.donvitinhs=[];n.donvitinh={};r="/API/DM_DonViTinhAPI";n.lydoXuats=[];n.lydoXuat={};u="/API/DM_LyDoXuatAPI";n.modifyXuatHang=!1;n.deleteXuatHang=!1;n.reviewXuatHang=!1;n.titlePopupModifyXuatHang="Thêm Phiếu xuất hàng";n.popupModifyXuatHang={width:"auto",height:"auto",contentTemplate:"templateModifyXuatHang",showTitle:!0,resizeEnabled:!0,fullScreen:!0,bindingOptions:{title:"titlePopupModifyXuatHang",visible:"modifyXuatHang"}};n.popupDeleteXuatHang={width:"auto",height:"auto",contentTemplate:"templateDeleteXuatHang",showTitle:!1,bindingOptions:{visible:"deleteXuatHang"}};n.popupReviewXuatHang={width:"auto",height:"auto",contentTemplate:"templateReviewXuatHang",showTitle:!0,resizeEnabled:!0,fullScreen:!0,title:"Xem phiếu Xuất hàng",bindingOptions:{visible:"reviewXuatHang"}};n.modifyDonViTinh=!1;n.titlePopupModifyDonViTinh="Thêm đơn vị tính";n.popupModifyDonViTinh={width:"auto",height:"auto",contentTemplate:"templateModifyDonViTinh",showTitle:!0,resizeEnabled:!0,bindingOptions:{title:"titlePopupModifyDonViTinh",visible:"modifyDonViTinh"}};n.modifyLyDoXuat=!1;n.titlePopupModifyLyDoXuat="Thêm lý do xuất";n.popupModifyLyDoXuat={width:"auto",height:"auto",contentTemplate:"templateModifyLyDoXuat",showTitle:!0,resizeEnabled:!0,bindingOptions:{title:"titlePopupModifyLyDoXuat",visible:"modifyLyDoXuat"}};n.controlXuatHang={nguoiXuat:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"xuathang.nguoiXuat"}},lydoXuat:{displayExpr:"ten",valueExpr:"id",searchEnabled:!0,noDataText:"Không có dữ liệu",placeholder:"Chọn ...",bindingOptions:{items:"lydoXuats",value:"xuathang.idLyDoXuat"}},thoigian:{type:"date",displayFormat:"dd/MM/yyyy",bindingOptions:{value:"xuathang.thoigian"}},ghichu:{height:40,valueChangeEvent:"keyup",bindingOptions:{value:"xuathang.ghichu"}},addLyDoXuat:{icon:"plus",onClick:function(){n.AddLyDoXuat()}}};n.controlXuatHangReview={nguoiXuat:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"xuathangReview.nguoiXuat"}},lydoXuat:{displayExpr:"ten",valueExpr:"id",searchEnabled:!0,noDataText:"Không có dữ liệu",placeholder:"Chọn ...",readOnly:!0,bindingOptions:{items:"lydoXuats",value:"xuathangReview.idLyDoXuat"}},thoigian:{type:"date",displayFormat:"dd/MM/yyyy",readOnly:!0,bindingOptions:{value:"xuathangReview.thoigian"}},ghichu:{height:40,valueChangeEvent:"keyup",readOnly:!0,bindingOptions:{value:"xuathangReview.ghichu"}}};n.controlDonViTinh={ten:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"donvitinh.ten"}}};n.controlLyDoXuat={ten:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"lydoXuat.ten"}}};n.gridXuatHangs={bindingOptions:{dataSource:"xuathangs","columns[2].lookup.dataSource":"lydoXuats"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!0,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columns:[{alignment:"left",allowEditing:!1,caption:"ID",dataField:"id"},{alignment:"left",caption:"Thời gian",dataField:"thoigian",dataType:"date",format:"dd/MM/yyyy",customizeText:function(n){return n.valueText}},{caption:"Lý do xuất",dataField:"idLyDoXuat",lookup:{displayExpr:"ten",valueExpr:"id"}},{alignment:"left",caption:"Người xuất",dataField:"nguoiXuat",dataType:"string"},{alignment:"right",caption:"Tổng tiền",dataField:"tongTien",format:{type:"fixedPoint",precision:0}},{alignment:"left",caption:"Ghi chú",dataField:"ghichu",dataType:"string"},],editing:{mode:"cell",allowAdding:!1,allowDeleting:!1,allowUpdating:!1,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!0,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Danh sách Phiếu xuất hàng",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!0},grouping:{contextMenuEnabled:!0,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Kéo một cột vào đây để nhóm theo cột đó",visible:!1},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!0},hoverStateEnabled:!0,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!0},paging:{enabled:!0,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"onClick"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{texts:{count:"{0}",sum:"{0}"},groupItems:[{column:"id",summaryType:"count"},],totalItems:[{column:"id",summaryType:"count"},{column:"tongTien",summaryType:"sum",valueFormat:"fixedPoint"}]},wordWrapEnabled:!1,onToolbarPreparing:function(t){var i=t.component;t.toolbarOptions.items.unshift({location:"before",widget:"dxDateBox",options:{bindingOptions:{value:"filterXuatHang.tuNgay"},type:"date",displayFormat:"dd/MM/yyyy",hint:"Từ ngày",placeholder:"Từ ngày",max:new Date}},{location:"before",widget:"dxDateBox",options:{bindingOptions:{value:"filterXuatHang.denNgay",min:"filterXuatHang.tuNgay"},type:"date",displayFormat:"dd/MM/yyyy",hint:"Đến ngày",placeholder:"Đến ngày",max:new Date}},{location:"before",widget:"dxButton",options:{hint:"Lọc",icon:"search",type:"primary",onClick:function(){f()}}},{location:"after",widget:"dxButton",options:{hint:"Thêm",icon:"add",type:"success",onClick:function(){n.AddXuatHang()}}},{location:"after",widget:"dxButton",options:{hint:"Xem",icon:"search",type:"default",onClick:function(){n.ReviewXuatHang()}}},{location:"after",widget:"dxButton",options:{hint:"Xóa",icon:"trash",type:"danger",onClick:function(){n.DeleteXuatHang()}}},{location:"after",widget:"dxButton",options:{hint:"Load lại Dữ liệu",icon:"refresh",onClick:function(){f()}}})},onRowClick:function(t){var i=t.component;i.clickCount=i.clickCount?i.clickCount+1:1;i.clickCount==1?(i.lastClickTime=new Date,setTimeout(function(){i.lastClickTime=0;i.clickCount=0},350)):i.clickCount==2&&(new Date-i.lastClickTime<300&&(n.xuathangReview=angular.copy(t.data),n.ReviewXuatHang()),i.clickCount=0,i.lastClickTime=0)},onSelectionChanged:function(t){n.selectedXuatHangs=angular.copy(t.selectedRowsData)}};n.gridChiTietXuatHangs={bindingOptions:{dataSource:"chitietXuatHangs","columns[0].lookup.dataSource":"mathangs","columns[1].lookup.dataSource":"mathangs"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!1,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columns:[{caption:"Mặt hàng",dataField:"idMatHang",lookup:{displayExpr:"ten",valueExpr:"id"},allowEditing:!1},{caption:"ĐVT",dataField:"idMatHang",lookup:{displayExpr:"donvitinh",valueExpr:"id"},allowEditing:!1},{alignment:"right",caption:"Đơn giá",dataField:"dongia",format:{type:"fixedPoint",precision:0}},{alignment:"right",caption:"SL",dataField:"soluong",format:{type:"fixedPoint",precision:3}},{alignment:"right",caption:"Thành tiền",dataField:"thanhtien",format:{type:"fixedPoint",precision:0},allowEditing:!1},],editing:{mode:"cell",allowAdding:!1,allowDeleting:!0,allowUpdating:!0,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!1,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Danh sách Hàng hóa",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!1},grouping:{contextMenuEnabled:!1,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Kéo một cột vào đây để nhóm theo cột đó",visible:!1},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!1},hoverStateEnabled:!1,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!0},paging:{enabled:!0,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"none"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{texts:{count:"{0}",sum:"{0}"},groupItems:[{column:"id",summaryType:"count"}],totalItems:[{column:"id",summaryType:"count"}]},wordWrapEnabled:!1,onRowInserted:function(){i()},onRowRemoved:function(){i()},onRowUpdated:function(){i()}};n.gridChiTietXuatHangReviews={bindingOptions:{dataSource:"chitietXuatHangReviews","columns[0].lookup.dataSource":"mathangs","columns[1].lookup.dataSource":"mathangs"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!1,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columns:[{caption:"Mặt hàng",dataField:"idMatHang",lookup:{displayExpr:"ten",valueExpr:"id"},allowEditing:!1},{caption:"ĐVT",dataField:"idMatHang",lookup:{displayExpr:"donvitinh",valueExpr:"id"},allowEditing:!1},{alignment:"right",caption:"Đơn giá",dataField:"dongia",format:{type:"fixedPoint",precision:0}},{alignment:"right",caption:"SL",dataField:"soluong",format:{type:"fixedPoint",precision:3}},{alignment:"right",caption:"Thành tiền",dataField:"thanhtien",format:{type:"fixedPoint",precision:0},allowEditing:!1},],editing:{mode:"cell",allowAdding:!1,allowDeleting:!1,allowUpdating:!1,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!1,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Danh sách Thực đơn",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!1},grouping:{contextMenuEnabled:!1,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Kéo một cột vào đây để nhóm theo cột đó",visible:!1},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!1},hoverStateEnabled:!1,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!0},paging:{enabled:!0,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"none"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{texts:{count:"{0}",sum:"{0}"},groupItems:[{column:"id",summaryType:"count"}],totalItems:[{column:"id",summaryType:"count"}]},wordWrapEnabled:!1,onRowInserted:function(){i()},onRowRemoved:function(){i()},onRowUpdated:function(){i()}};n.lookupMatHangs={bindingOptions:{items:"mathangs",value:"mathang.id"},cancelButtonText:"Đóng",clearButtonText:"Xóa",displayExpr:"ten",nextButtonText:"Thêm",noDataText:"Không có dữ liệu",valueExpr:"id",title:"Chọn mặt hàng",pageLoadingText:"Đang tải...",placeholder:"Chọn mặt hàng",searchPlaceholder:"Tìm kiếm",onItemClick:function(n){y(n.itemData)},onClosed:function(){var n=$("#lookupMatHangs").dxLookup("instance");n.reset()}};l=[{value:"add",text:" Thêm",icon:"fa fa-plus"},{value:"review",text:" Xem",icon:"fa fa-search"},{value:"delete",text:" Xóa",icon:"fa fa-times"}];n.contextMenuXuatHang={dataSource:l,width:100,target:"#xuathang",itemTemplate:function(n){var t=$("<div><\/div>");return n.icon&&t.append('<span class="'+n.icon+'"><span>'),t.append(n.text),t},onItemClick:function(t){if(!t.itemData.items)switch(t.itemData.value){case"add":n.AddXuatHang();break;case"review":n.ReviewXuatHang();break;case"delete":n.DeleteXuatHang()}}};a();n.AddXuatHang=function(){n.xuathang={thoigian:new Date,idLyDoXuat:1,tongTien:0};n.chitietXuatHangs=[];n.chitietXuatHang={};n.titlePopupModifyXuatHang="Thêm Phiếu xuất hàng";n.modifyXuatHang=!0};n.SaveXuatHang=function(){t.post(e,n.xuathang).then(function(i){i.status==201?(n.xuathang=angular.copy(i.data),angular.forEach(n.chitietXuatHangs,function(i){i.idXuatHang=n.xuathang.id;t.post(o,i).then(function(n){t.get("/MatHang/XuatHang/"+n.data.id).then(function(){})})}),n.modifyXuatHang=!1,toastr.success("Thành công","Lưu"),f()):toastr.error("Thất bại","Lưu")})};n.CancelSaveXuatHang=function(){n.xuathang={};n.chitietXuatHangs=[];n.chitietXuatHang={};n.modifyXuatHang=!1};n.DeleteXuatHang=function(){n.selectedXuatHangs.length==0?toastr.error("Chọn dòng để xóa"):n.deleteXuatHang=!0};n.ConfirmDeleteXuatHang=function(){angular.forEach(n.selectedXuatHangs,function(i){t.delete("/XuatHang/Delete/"+i.id).then(function(t){t.status==200&&t.data==1?angular.forEach(n.xuathangs,function(t,r){i.id===t.id&&n.xuathangs.splice(r,1)}):toastr.error("Thất bại","Xóa")})});toastr.success("Thành công","Xóa");n.deleteXuatHang=!1};n.CancelDeleteXuatHang=function(){n.deleteXuatHang=!1};n.ReviewXuatHang=function(){n.selectedXuatHangs.length==0?toastr.error("Chọn 1 dòng để xem"):(n.xuathangReview=angular.copy(n.selectedXuatHangs[0]),p(n.xuathangReview.id),n.reviewXuatHang=!0)};n.AddDonViTinh=function(){n.donvitinh={};n.titlePopupModifyDonViTinh="Thêm đơn vị tính";n.modifyDonViTinh=!0};n.SaveDonViTinh=function(){angular.isDefined(n.donvitinh.id)?t.put(r+"/"+n.donvitinh.id,n.donvitinh).then(function(t){t.status==204?(s(),toastr.success("Thành công","Sửa"),n.modifyDonViTinh=!1):toastr.error("Thất bại","Sửa")}):t.post(r,n.donvitinh).then(function(t){t.status==201?(s(),toastr.success("Thành công","Thêm"),n.modifyDonViTinh=!1):toastr.error("Thất bại","Thêm")})};n.CancelSaveDonViTinh=function(){n.modifyDonViTinh=!1};n.AddLyDoXuat=function(){n.lydoXuat={};n.titlePopupModifyLyDoXuat="Thêm lý do xuất";n.modifyLyDoXuat=!0};n.SaveLyDoXuat=function(){angular.isDefined(n.lydoXuat.id)?t.put(u+"/"+n.lydoXuat.id,n.lydoXuat).then(function(t){t.status==204?(h(),toastr.success("Thành công","Sửa"),n.modifyLyDoXuat=!1):toastr.error("Thất bại","Sửa")}):t.post(u,n.lydoXuat).then(function(t){t.status==201?(h(),toastr.success("Thành công","Thêm"),n.modifyLyDoXuat=!1):toastr.error("Thất bại","Thêm")})};n.CancelSaveLyDoXuat=function(){n.modifyLyDoXuat=!1}}]);