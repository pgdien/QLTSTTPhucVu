admin.controller("banhangController",["$scope","$http",function(n,t){function v(){y();i();w();b();k();g()}function y(){t.get(o).then(function(t){t.status==200&&(n.khuvucs=t.data)})}function i(){n.khuvuc.id==null?t.get(r).then(function(t){t.status==200&&(n.bans=t.data)}):t.get(r+"?att=idKhuVuc&&value="+n.khuvuc.id).then(function(t){t.status==200&&(n.bans=t.data)})}function p(t){n.ban=angular.copy(t);n.titlePopupModifyHoaDonBanHang="Hóa đơn "+n.ban.ten;n.hoadonBanHang={};n.chitietHoaDonBanhang={};n.chitietHoaDonBanHangs=[];n.chitietNhanVienHoaDonBanHang={};n.chitietNhanVienHoaDonBanHangs=[];t.trangthai==!1?n.createHoaDonBanHang=!0:(nt(),n.modifyHoaDonBanHang=!0)}function w(){t.get(f).then(function(t){t.status==200&&(n.khachhangs=t.data)})}function b(){t.get(a).then(function(t){t.status==200&&(n.donvitinhs=t.data)})}function k(){t.get(c).then(function(t){t.status==200&&(n.thucdonTemplates=angular.copy(t.data),n.thucdons=angular.copy(n.thucdonTemplates))})}function d(t){n.thucdons=[];angular.forEach(n.thucdonTemplates,function(i){i.ten.toLowerCase().includes(t.toLowerCase())&&n.thucdons.push(i)})}function g(){t.get(l).then(function(t){t.status==200&&(n.nhanvienPhucVus=t.data)})}function nt(){t.get(u+"?att=idBan&&value="+n.ban.id).then(function(i){i.status==200&&(n.hoadonBanHang=i.data[0],n.hoadonBanHang.thoigianVao=new Date(n.hoadonBanHang.thoigianVao),n.hoadonBanHang.thoigianRa=new Date,t.get("/HoaDonBanHang/GetChiTiet/"+n.hoadonBanHang.id).then(function(t){t.status==200&&(n.chitietHoaDonBanHangs=angular.copy(t.data.ChiTietThucDons),n.chitietNhanVienHoaDonBanHangs=angular.copy(t.data.ChiTietNhanViens),n.TinhTien())}))})}function e(t){var i=!1,r;angular.forEach(n.chitietHoaDonBanHangs,function(n){n.idThucDon==t.id&&(i=!0,toastr.warning("Đã tồn tại","Thuốc đơn"))});i==!1&&(r={idThucDon:t.id,idHoaDonBanHang:n.hoadonBanHang.id,soluong:1,dongia:t.dongia},n.chitietHoaDonBanHangs.push(r),n.thucdon={});n.TinhTien()}function tt(t){var i=!1,r;angular.forEach(n.chitietNhanVienHoaDonBanHangs,function(n){n.idNhanVienPhucVu==t.id&&(i=!0,toastr.warning("Đã tồn tại","Nhân viên phục vụ"))});i==!1&&(r={idNhanVienPhucVu:t.id,idHoaDonBanHang:n.hoadonBanHang.id,thoigian:60,dongia:t.dongia},n.chitietNhanVienHoaDonBanHangs.push(r));n.TinhTien()}var o,r,u,s,h,c,l,a,f;n.khuvucs=[];n.khuvuc={};o="/API/DM_KhuVucAPI/";n.bans=[];n.ban={};r="/API/DM_BanAPI";n.hoadonBanHang={};n.causeCancelHoaDonBanHang={};u="/API/ORDER_HoaDonBanHangAPI";n.chitietHoaDonBanHangs=[];n.chitietHoaDonBanhang={};s="/API/ORDER_ChiTietHoaDonBanHangAPI";n.chitietNhanVienHoaDonBanHangs=[];n.chitietNhanVienHoaDonBanHang={};h="/API/ORDER_ChiTietNhanVienHoaDonBanHangAPI";n.thucdonsTemplates=[];n.thucdons=[];n.thucdon={};n.filterNhomThucDon="";c="/API/DM_ThucDonAPI";n.nhanvienPhucVus=[];n.nhanvienPhucVu={};n.selectedNhanVienPhucVus=[];l="/API/DM_NhanVienPhucVuAPI";n.donvitinhs=[];n.donvitinh={};a="/API/DM_DonViTinhAPI";n.khachhangs=[];n.khachhang={};f="/API/DM_KhachHangAPI";n.print={};n.print.thucdons=[];n.print.nhanviens=[];n.modifyHoaDonBanHang=!1;n.cancelHoaDonBanHang=!1;n.createHoaDonBanHang=!1;n.thanhtoanHoaDonBanHang=!1;n.titlePopupModifyHoaDonBanHang="Hóa đơn "+n.ban.ten;n.popupModifyHoaDonBanHang={width:"auto",height:"auto",contentTemplate:"templateModifyHoaDonBanHang",showTitle:!0,resizeEnabled:!0,fullScreen:!0,showCloseButton:!1,bindingOptions:{title:"titlePopupModifyHoaDonBanHang",visible:"modifyHoaDonBanHang"}};n.popupCreateHoaDonBanHang={width:"auto",height:"auto",contentTemplate:"templateCreateHoaDonBanHang",showTitle:!0,resizeEnabled:!0,fullScreen:!1,title:"Mở bàn",bindingOptions:{visible:"createHoaDonBanHang"}};n.popupCancelHoaDonBanHang={width:"auto",height:"auto",contentTemplate:"templateCancelHoaDonBanHang",showTitle:!0,resizeEnabled:!0,title:"Lý do hủy",bindingOptions:{visible:"cancelHoaDonBanHang"}};n.popupThanhToanHoaDonBanHang={width:"auto",height:"auto",contentTemplate:"templateThanhToanHoaDonBanHang",showTitle:!0,resizeEnabled:!0,fullScreen:!1,title:"Thanh toán",bindingOptions:{visible:"thanhtoanHoaDonBanHang"}};n.modifyKhachHang=!1;n.titlePopupModifyKhachHang="Thêm khách hàng";n.popupModifyKhachHang={width:"auto",height:"auto",contentTemplate:"templateModifyKhachHang",showTitle:!0,resizeEnabled:!0,bindingOptions:{title:"titlePopupModifyKhachHang",visible:"modifyKhachHang"}};n.controlHoaDonBanHang={nhanvien:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"hoadonBanHang.nhanvien"}},soKhach:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"hoadonBanHang.soKhach"}},tongThoiGian:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"hoadonBanHang.tongThoiGian"}},lydoHuy:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"hoadonBanHang.lydoHuy"}},khachhang:{displayExpr:"ten",valueExpr:"id",searchEnabled:!0,noDataText:"Không có dữ liệu",placeholder:"Chọn ...",bindingOptions:{items:"khachhangs",value:"hoadonBanHang.idKhachHang"}},thoigianVao:{type:"time",applyButtonText:"Xong",cancelButtonText:"Hủy",displayFormat:"HH:mm",bindingOptions:{value:"hoadonBanHang.thoigianVao"}},thoigianRa:{type:"time",applyButtonText:"Xong",cancelButtonText:"Hủy",displayFormat:"HH:mm",bindingOptions:{value:"hoadonBanHang.thoigianRa"}},ghichu:{height:40,valueChangeEvent:"keyup",bindingOptions:{value:"hoadonBanHang.ghichu"}},addKhachHang:{icon:"plus",onClick:function(){n.AddKhachHang()}}};n.controlCancelHoaDonBanHang={lydo:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"hoadonBanHang.lydoHuy"}}};n.controlKhachHang={ten:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"khachhang.ten"}},dienthoai:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"khachhang.dienthoai"}},diachi:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"khachhang.diachi"}},email:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"khachhang.email"}},masoThue:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"khachhang.masoThue"}}};n.controlMaVach={mavach:{showClearButton:!0,valueChangeEvent:"keyup",placeholder:"Bắn mã vạch",bindingOptions:{value:"thucdon.mavach"},onEnterKey:function(){var t=[];angular.forEach(n.thucdonTemplates,function(i){i.mavach!=null&&i.mavach.includes(n.thucdon.mavach)&&t.push(i)});t.length>0?t.length==1?(n.thucdon=t[0],e(n.thucdon)):n.thucdons=angular.copy(t):toastr.error("Không tìm thấy");n.thucdon={}}}};n.controlThucDon={filter:{valueChangeEvent:"keypress",placeholder:"Tìm kiếm",mode:"search",bindingOptions:{value:"filterThucDon"},onValueChanged:function(){d(n.filterThucDon)}}};n.listKhuVucs={bindingOptions:{dataSource:"khuvucs"},height:"100%",onItemClick:function(t){n.khuvuc=angular.copy(t.itemData);i()},onItemContextMenu:function(t){n.khuvuc=angular.copy(t.itemData)}};n.tileViewBans={width:800,height:500,baseItemHeight:117,baseItemWidth:120,itemMargin:10,direction:"vertical",bindingOptions:{items:"bans"},onItemClick:function(n){p(n.itemData)}};n.gridChiTietHoaDonBanHangs={bindingOptions:{dataSource:"chitietHoaDonBanHangs","columns[0].lookup.dataSource":"thucdonTemplates","columns[1].lookup.dataSource":"thucdonTemplates"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!1,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columns:[{caption:"Thuốc đơn",dataField:"idThucDon",lookup:{displayExpr:"ten",valueExpr:"id"},allowEditing:!1},{caption:"ĐVT",dataField:"idThucDon",lookup:{displayExpr:"donvitinh",valueExpr:"id"},allowEditing:!1},{alignment:"right",caption:"Đơn giá",dataField:"dongia",format:{type:"fixedPoint",precision:0}},{alignment:"right",caption:"SL",dataField:"soluong",format:{type:"fixedPoint",precision:0}},{alignment:"right",caption:"Thành tiền",dataField:"thanhtien",format:{type:"fixedPoint",precision:0},allowEditing:!1},],editing:{mode:"cell",allowAdding:!1,allowDeleting:!0,allowUpdating:!0,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!1,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Danh sách Thực đơn",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!1},grouping:{contextMenuEnabled:!1,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Kéo một cột vào đây để nhóm theo cột đó",visible:!1},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!1},hoverStateEnabled:!1,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!1},paging:{enabled:!1,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"none"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{texts:{count:"{0}",sum:"{0}"},groupItems:[{column:"id",summaryType:"count"}],totalItems:[{column:"id",summaryType:"count"}]},wordWrapEnabled:!1,onRowInserted:function(){n.TinhTien()},onRowRemoved:function(){n.TinhTien()},onRowUpdated:function(){n.TinhTien()}};n.gridChiTietNhanVienHoaDonBanHangs={bindingOptions:{dataSource:"chitietNhanVienHoaDonBanHangs","columns[0].lookup.dataSource":"nhanvienPhucVus"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!1,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columns:[{caption:"Nhân viên",dataField:"idNhanVienPhucVu",lookup:{displayExpr:"ten",valueExpr:"id"},allowEditing:!1},{alignment:"right",caption:"ĐG",dataField:"dongia",format:{type:"fixedPoint",precision:0}},{alignment:"right",caption:"T/G",dataField:"thoigian",format:{type:"fixedPoint",precision:0}},{alignment:"right",caption:"Thành tiền",dataField:"thanhtien",format:{type:"fixedPoint",precision:0},allowEditing:!1},],editing:{mode:"cell",allowAdding:!1,allowDeleting:!0,allowUpdating:!0,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!1,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Danh sách Thực đơn",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!1},grouping:{contextMenuEnabled:!1,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Kéo một cột vào đây để nhóm theo cột đó",visible:!1},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!1},hoverStateEnabled:!1,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!1},paging:{enabled:!1,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"none"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{texts:{count:"{0}",sum:"{0}"},groupItems:[{column:"id",summaryType:"count"}],totalItems:[{column:"id",summaryType:"count"}]},wordWrapEnabled:!1,onRowInserted:function(){n.TinhTien()},onRowRemoved:function(){n.TinhTien()},onRowUpdated:function(){n.TinhTien()}};n.lookupThucDons={bindingOptions:{items:"thucdons",value:"thucdon.id"},cancelButtonText:"Đóng",clearButtonText:"Xóa",displayExpr:"ten",nextButtonText:"Thêm",noDataText:"Không có dữ liệu",valueExpr:"id",title:"Chọn thuốc đơn",pageLoadingText:"Đang tải...",placeholder:"Chọn thuốc đơn",searchPlaceholder:"Tìm kiếm",onItemClick:function(n){e(n.itemData)},onClosed:function(){var n=$("#lookupThucDons").dxLookup("instance");n.reset()}};n.listThucDons={bindingOptions:{dataSource:"thucdons"},height:"490",nextButtonText:"Xem thêm",onItemClick:function(n){e(n.itemData)}};n.lookupNhanVienPhucVus={bindingOptions:{items:"nhanvienPhucVus",value:"nhanvienPhucVu.id"},cancelButtonText:"Đóng",clearButtonText:"Xóa",displayExpr:"ten",nextButtonText:"Thêm",noDataText:"Không có dữ liệu",valueExpr:"id",title:"Chọn nhân viên",pageLoadingText:"Đang tải...",placeholder:"Chọn nhân viên",searchPlaceholder:"Tìm kiếm",onItemClick:function(n){tt(n.itemData)},onClosed:function(){var n=$("#lookupNhanVienPhucVus").dxLookup("instance");n.reset()}};v();n.GetAllBan=function(){n.khuvuc={};i()};n.AddKhachHang=function(){n.khachhang={};n.titlePopupModifyKhachHang="Thêm khách hàng";n.modifyKhachHang=!0};n.SaveKhachHang=function(){angular.isDefined(n.khachhang.id)?t.put(f+"/"+n.khachhang.id,n.khachhang).then(function(t){t.status==204?angular.forEach(n.khachhangs,function(t,i){t.id==n.khachhang.id&&(n.khachhangs[i]=angular.copy(n.khachhang),toastr.success("Thành công","Sửa"),n.modifyKhachHang=!1)}):toastr.error("Thất bại","Sửa")}):t.post(f,n.khachhang).then(function(t){t.status==201?(n.khachhangs.push(t.data),toastr.success("Thành công","Thêm"),n.modifyKhachHang=!1):toastr.error("Thất bại","Thêm")})};n.CancelSaveKhachHang=function(){n.modifyKhachHang=!1};n.CreateHoaDonBanHang=function(){n.ban.trangthai=!0;t.put(r+"/"+n.ban.id,n.ban).then(function(r){r.status==204&&(i(),n.hoadonBanHang={idKhachHang:1,idBan:n.ban.id,soKhach:1,thoigianVao:new Date,thoigianRa:new Date,tongThoiGian:0,dongiaPhong:1e5,tienGio:0,isHuy:!1,tienDo:0,tienNhanVien:0,tongTien:0,giamTien:0,isThanhToan:!1,thanhtoan:0,thucthu:0,tienle:0},t.post(u,n.hoadonBanHang).then(function(t){t.status==201&&(n.hoadonBanHang=angular.copy(t.data),n.modifyHoaDonBanHang=!0,n.createHoaDonBanHang=!1)}))})};n.CancelCreateHoaDonBanHang=function(){n.createHoaDonBanHang=!1};n.SaveHoaDonBanHang=function(){t.put(u+"/"+n.hoadonBanHang.id,n.hoadonBanHang).then(function(i){i.status==204&&t.get("/HoaDonBanHang/DeleteChiTiet/"+n.hoadonBanHang.id).then(function(i){i.status==200&&i.data==1?(angular.forEach(n.chitietHoaDonBanHangs,function(n){t.post(s,n).then(function(){})}),angular.forEach(n.chitietNhanVienHoaDonBanHangs,function(n){t.post(h,n).then(function(){})}),toastr.success("Thành công","Lưu")):toastr.error("Thất bại","Lưu")})})};n.SaveAndCloseHoaDonBanHang=function(){n.SaveHoaDonBanHang();n.modifyHoaDonBanHang=!1};n.ThanhToan=function(){n.thanhtoanHoaDonBanHang=!0};n.ConfirmThanhToanHoaDonBanHang=function(){n.hoadonBanHang.isThanhToan=!0;n.SaveHoaDonBanHang();t.put("/HoaDonBanHang/ThanhToan/"+n.hoadonBanHang.id).then(function(t){t.status==200&&t.data==1?(i(),n.modifyHoaDonBanHang=!1,n.thanhtoanHoaDonBanHang=!1,toastr.success("Thành công","Thanh toán")):toastr.error("Thất bại","Thanh toán")})};n.CancelThanhToanHoaDonBanHang=function(){n.thanhtoanHoaDonBanHang=!1};n.CancelHoaDonBanHang=function(){n.cancelHoaDonBanHang=!0};n.ConfirmCancelHoaDonBanHang=function(){t.get("/HoaDonBanHang/Cancel?id="+n.hoadonBanHang.id).then(function(t){t.status==200&&t.data==1?(n.hoadonBanHang.isHuy=!0,n.SaveAndCloseHoaDonBanHang(),i(),toastr.success("Thành công","Hủy bàn")):toastr.error("Thất bại","Hủy bàn")});n.cancelHoaDonBanHang=!1};n.CancelCancelHoaDonBanHang=function(){n.cancelHoaDonBanHang=!1};n.CloseHoaDonBanHang=function(){n.modifyHoaDonBanHang=!1};n.TinhTien=function(){var t=0,i=0,r=n.hoadonBanHang.tienle,u=n.hoadonBanHang.giamTien,f=new Date;angular.forEach(n.chitietHoaDonBanHangs,function(i,r){n.chitietHoaDonBanHangs[r].thanhtien=parseFloat(i.dongia)*parseFloat(i.soluong);t=parseFloat(t)+parseFloat(n.chitietHoaDonBanHangs[r].thanhtien)});n.hoadonBanHang.tienDo=t;i=parseFloat(t);n.hoadonBanHang.tongTien=i;n.hoadonBanHang.thanhtoan=parseFloat(i)-parseFloat(u);n.hoadonBanHang.thucthu=parseFloat(n.hoadonBanHang.thanhtoan)-parseFloat(r);n.CreatePrint()};n.CreatePrint=function(){n.print={thucdons:[]};angular.forEach(n.chitietHoaDonBanHangs,function(t){angular.forEach(n.thucdonTemplates,function(i){if(t.idThucDon==i.id){var r=angular.copy(t);r.tenThucDon=i.ten;r.huongdan=i.huongdan;n.print.thucdons.push(r)}})})}}]);